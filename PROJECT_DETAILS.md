# Project Overview & Business Logic

## Project Overview

The **Next.js Firebase Push Notification Demo** is a modern web application built with **Next.js 14** that demonstrates the integration of **Firebase Cloud Messaging (FCM)** for browser-based push notifications. 

Unlike typical implementations where Firebase config is hardcoded, this project features a **dynamic configuration system** that allows users to set up their Firebase project credentials directly through the application's user interface.

### Key Technologies
- **Framework**: Next.js 14 (Pages Router)
- **Messaging**: Firebase v10+ (FCM)
- **Storage**: LocalForage (IndexedDB/LocalStorage) for persistent client-side configuration
- **UI/UX**: React Toastify for real-time notification feedback
- **Service Workers**: Custom FCM service worker for background message handling

### Key Features
- ✅ **Dynamic Configuration**: Configure Firebase settings via browser UI.
- ✅ **Token Management**: Easy access to FCM tokens for testing.
- ✅ **Message Persistence**: Automatically save notification history to **IndexedDB** (persistent across reloads).
- ✅ **Premium Custom Toast UI**: Beautifully designed real-time notifications for both foreground and background messages.
- ✅ **Foreground/Background Handling**: Seamless notification delivery regardless of tab focus.

---

## Business Logic & Application Flow

### 1. Configuration Lifecycle
The application follows a plug-and-play logic where the Firebase environment is initialized at runtime based on user-provided settings.

- **Check**: On application load, `PushNotificationLayout` checks `localforage` for a `firebase_config` object.
- **Redirect/Prompt**: If missing, it prompts the user to visit `/settings`.
- **Save**: When a user saves their Firebase credentials (API Key, Project ID, etc.) and VAPID key, the app reloads to apply the new environment.

### 2. Initialization & Permission Flow
Once configuration is present, the following sequence occurs:
1. **Firebase Init**: The Firebase app is initialized using the saved configuration.
2. **Service Worker Registration**: `/firebase-messaging-sw.js` is registered.
3. **Post-Message Sync**: The application sends the Firebase configuration to the active Service Worker via `postMessage` to ensure the background listener has the correct credentials.
4. **Permission Request**: The browser requests the user for "Notification" permissions.
5. **Token Acquisition**: Upon permission grant, a unique **FCM Registration Token** is generated using the VAPID key. This token is stored locally and displayed on the home page.

### 3. Messaging Logic

#### Foreground Notifications
- **Listener**: `onMessage` from the Firebase SDK.
- **Action**: When a message arrives while the tab is active, a custom Toast (via `react-toastify`) is displayed containing the notification title and body.

#### Background Notifications
- **Listener**: `onBackgroundMessage` inside the Service Worker.
- **Action**: The Service Worker displays a native browser notification.
- **Client Sync**: If a tab is active but not focused, the Service Worker sends a message back to the client via the `navigator.serviceWorker` message channel to trigger a foreground toast sync.

### 4. Navigation & Interactivity
- **Data Payloads**: Notifications can include a `url` in their data payload.
- **Handling**: Clicking a toast or notification redirects the user to the specified path within the application using `next/router`.

---

## Testing Ecosystem

To facilitate end-to-end testing, the project includes a companion **.NET Console Application** located in `/firebase-test-proj`.

### .NET Test Tool Features
- **Firebase Admin SDK**: Uses the authoritative Firebase Admin SDK to send messages.
- **Service Account Integration**: Authenticates via `serviceAccountKey.json`.
- **Customizable Payloads**: Allows interactive input for notification title, body, image URL, and link actions.
- **Token Targeting**: Accepts the FCM token generated by the Next.js web app to send targeted test messages.

### Testing Workflow
1. Start the Next.js app and navigate to the Home page to get your **FCM Token**.
2. Run the `.NET Console App` via `run.bat` in the `/firebase-test-proj` directory, or use the **[Firebase Console](https://console.firebase.google.com/u/0/project/csharp-firestore-2022/notification/compose)** directly.
3. Paste the FCM Token into the console when prompted.
4. Compose the message and send.
5. Observe the notification appearing in the Next.js web app (foreground or background).

---

## Project Structure
- `/pages/settings.js`: Interface for dynamic Firebase configuration.
- `/utils/firebase.js`: Core logic for Firebase initialization and token management.
- `/components/PushNotificationLayout.js`: Wrapper component that manages the app-wide notification state and listeners.
- `/public/firebase-messaging-sw.js`: The "brain" for background notifications.
- `/firebase-test-proj/`: Companion .NET tool for programmatic notification testing.
